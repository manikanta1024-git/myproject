#!/usr/bin/env bash
# install-nginx.sh
# Usage: sudo bash install-nginx.sh
set -euo pipefail

log() { printf '%s\n' "$*"; }

if [ "$(id -u)" -ne 0 ]; then
    log "This script must be run as root. Try: sudo $0"
    exit 1
fi

detect_pkg() {
    if command -v apt-get >/dev/null 2>&1; then
        echo "apt"
    elif command -v dnf >/dev/null 2>&1; then
        echo "dnf"
    elif command -v yum >/dev/null 2>&1; then
        echo "yum"
    else
        echo "unknown"
    fi
}

PKG_MANAGER=$(detect_pkg)
log "Detected package manager: $PKG_MANAGER"

install_nginx_apt() {
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -y
    apt-get install -y nginx
}

install_nginx_yum() {
    # Works for Amazon Linux, CentOS, RHEL
    if ! yum list installed epel-release >/dev/null 2>&1 && ! rpm -q epel-release >/dev/null 2>&1; then
        if yum --showduplicates list available epel-release >/dev/null 2>&1; then
            yum install -y epel-release || true
        fi
    fi
    yum install -y nginx || { yum makecache -y && yum install -y nginx; } || { log "Failed to install nginx with yum."; exit 3; }
}

install_nginx_dnf() {
    if ! dnf install -y nginx; then
        dnf makecache -y
        if ! dnf install -y nginx; then
            log "Failed to install nginx with dnf."
            exit 3
        fi
    fi
}

case "$PKG_MANAGER" in
log "Enabling and starting nginx"
if command -v systemctl >/dev/null 2>&1; then
    systemctl enable --now nginx
elif command -v service >/dev/null 2>&1; then
    service nginx start
else
    log "Could not start nginx automatically. Please start it manually."
fi
    dnf)   install_nginx_dnf ;;
    *)     log "Unsupported package manager. Install nginx manually."; exit 2 ;;
esac
# Use FQDN if available, otherwise fall back to short hostname.
# Note: If the system is not configured with a proper FQDN, 'hostname --fqdn' may fail and fall back to 'hostname', which could result in unexpected output in the index page.
HOSTNAME="$(hostname --fqdn 2>/dev/null || hostname)"
cat > "$INDEX_PATH" <<EOF
<html>
<head><title>Nginx on EC2</title></head>
# Create a simple index page
INDEX_PATH="/usr/share/nginx/html/index.html"
HOSTNAME="$(hostname --fqdn 2>/dev/null || hostname)"
cat > "$INDEX_PATH" <<EOF
<html>
<head><title>Nginx on EC2</title></head>
<body>
<h1>Nginx is running</h1>
<p>Host: $HOSTNAME</p>
<p>Time: $(date -u +"%Y-%m-%d %H:%M:%SZ") (UTC)</p>
</body>
</html>
EOF
if command -v firewall-cmd >/dev/null 2>&1; then
    log "Opening HTTP port in firewalld"
    if ! firewall-cmd --permanent --add-service=http >/dev/null 2>&1; then
        log "Warning: Failed to add HTTP service to firewalld."
    fi
    if ! firewall-cmd --reload >/dev/null 2>&1; then
elif command -v ufw >/dev/null 2>&1; then
    log "Allowing HTTP in ufw"
    if ! ufw allow 80/tcp >/dev/null 2>&1; then
        log "Warning: Failed to allow HTTP in ufw. Please check ufw status and configuration."
    fi
fi
    ufw allow 80/tcp >/dev/null 2>&1 || true
fi
    ufw allow 80/tcp >/dev/null 2>&1 || true
fi

log "Nginx installed and started."
log "Note: To access from the internet, ensure the EC2 security group allows inbound TCP port 80."
log "You can test locally: curl -I http://localhost"